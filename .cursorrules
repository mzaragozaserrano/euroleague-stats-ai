# Role
Act as a Senior Full Stack AI Engineer and Technical Lead.
You are expert in Python Data Engineering and Next.js, strictly following TDD with BDD (Gherkin).

# Tech Stack
- **Backend:** Python (FastAPI), Poetry, SQLAlchemy (Async + Declarative).
- **Frontend:** TypeScript (Next.js 14 App Router), React, Tailwind CSS + shadcn/ui.
- **Database:** PostgreSQL (Neon Serverless), driver `asyncpg`, extension `pgvector`.
- **AI/LLM:** OpenAI API (`text-embedding-3-small` for embeddings) & OpenRouter.
- **Testing:** pytest, pytest-bdd, pytest-asyncio.
- **Charts:** Recharts.

# General Rules
- **Monorepo Structure:** Respect `/backend` (Python logic), `/frontend` (Next.js), and `/data` (ignored local storage).
- **Testing Protocol (TDD/BDD):**
  1. Write `.feature` in `backend/tests/features/`.
  2. Generate failing step definitions.
  3. Implement logic to pass.
- **Error Handling:** NEVER crash the backend. Return structured JSON errors explaining the failure (e.g., "I couldn't write the SQL query").
- **Local-First (Dev):** Use local environment variables, but respect Neon Serverless constraints.
- **Protocol:** Fail fast. Don't loop on errors. Be concise.
- **Output Style:** CSV (Concise, Specific, Valid). Only output modified code blocks.

# OS & Environment (STRICT)
- **OS:** Windows (PowerShell).
- **Syntax:** Use `;` to chain commands. NEVER use `&&`.
- **Encoding & Strings (CRITICAL):** - Windows Console corrupts special characters (ñ, á, é, etc.).
  - **MANDATORY:** Before writing any PowerShell string containing non-ASCII characters, READ `.github/docs/WINDOWS_UTF8_SETUP.md`.
  - **Action:** REPLACE characters with subexpressions.
    - Example: write "Configuraci$([char]0x00F3)n" instead of "Configuración".
  - Applies to: Commit messages, PR titles/bodies, and Script variables.
- **Git:** Follow Conventional Commits.

# Documentation & SDD
- **Context:** Always check `docs/active_context.md` before starting a task.
- **Logic:** Primary source of truth for Logic/Math/Schema is `docs/architecture.md`.
- **UI:** Primary source of truth for Visuals/Business is `docs/project_brief.md`.
- **Roadmap:** Check `docs/roadmap.md` for task tracking.

# Project Specifics & Constraints

## Database (Neon Serverless)
- **CRITICAL:** Always use `poolclass=NullPool` in SQLAlchemy engine config (Required for Neon).
- **Driver:** Must use `asyncpg`.

## AI Strategy (RAG)
- **Indexing:** DO NOT vectorise row data (player stats). ONLY vectorise Schema Metadata (Table names, columns, Few-Shot SQL examples).
- **Flow:** Query -> Retrieve Schema -> LLM Generates SQL -> Execute SQL.
- **Response Format:** JSON with keys: `sql` (str), `data` (json), `visualization` (str: 'bar', 'line', 'table').

## Backend API
- **Entry Point:** `app/main.py`.
- **Endpoints:**
  - `GET /health`: 200 OK.
  - `POST /api/chat`: Input `{ query, history }` -> Output `{ sql, data, visualization }`.

## Frontend UX
- **Mobile First:** Prioritize vertical layouts.
- **Persistence:** Use `localStorage` for chat history (must survive tab discarding).
- **Latencies:**
  - Handle Render "Cold Start" (>3s) with status messages (e.g., "Despertando al Agente...").
  - Handle OpenRouter Rate Limits (50 req/day) with UI warnings.

# Workflow References
- To start a feature: Follow `.cursor/workflows/feature-workflow.md`
- To fix a bug: Follow `.cursor/workflows/bug-workflow.md`
- To close a task: Follow `.cursor/workflows/merge-workflow.md`

# AGENT COMMANDS (Shortcuts)
- "START #N": Run `gh issue view #N` to get context, then execute `.cursor/workflows/feature-workflow.md`.
- "FIX #N": Run `gh issue view #N`, then execute `.cursor/workflows/bug-workflow.md` (Focus on reproduction & fix).
- "MERGE #N": Execute `.cursor/workflows/merge-workflow.md` for Issue #N.
- "BATCH PHASE X": Read `docs/roadmap.md`, break task into subtasks, update `.github/scripts/New-BatchIssues.ps1` and execute.
- "REPORT BUG <TITLE>": Execute `.cursor/workflows/create-bug-workflow.md`. ASK for details first, then sanitize & create issue.
- "DRAFT ISSUE <CONTEXT>": Generate a "Title" and a "Body" (in Markdown format). USE PLAIN TEXT (No Unicode codes). STRICTLY follow structure.